/*! imageareaselecttouch - v0.0.0 - 2013-10-25
* https://github.com/gunderson/imageareaselecttouch
* Copyright (c) 2013 Patrick Gunderson; Licensed MIT */
(function(i){i.imageAreaSelectTouch=function(t,s){var o=this;s=i.extend(!0,{},i.imageAreaSelectTouch.options,s),this.options=s;var n,e,h,a,r,g,c,d,p,u=i(t);return this.dx=[0,0],this.dy=[0,0],this.dDist=0,this.px=[0,0],this.py=[0,0],this.pdDist=0,this.bgOffsetX=0,this.bgOffsetY=0,this.isDragging=!1,this.isPinching=!1,this.activeTouches=0,this.init=function(){d=u.attr("src");var t="url("+d+")";p=u[0].width/u[0].height,1>=p?(a=g=this.options.dimensions.width,r=c=this.options.dimensions.width/p):(a=g=this.options.dimensions.height*p,r=c=this.options.dimensions.height),n=i('<div class="jq-iast-wrapper">').css(i.extend({backgroundColor:"#000"},this.options.dimensions)),e=i('<div class="jq-iast-bg">').css(i.extend({backgroundImage:t,backgroundSize:a+"px "+r+"px",backgroundPositionX:(this.options.dimensions.width>>1)-(a>>1),backgroundPositionY:(this.options.dimensions.height>>1)-(r>>1)},this.options.bgDimensions)).appendTo(n);var s=(this.options.dimensions.width>>1)-(this.options.selectorDimensions.width>>1),m=(this.options.dimensions.height>>1)-(this.options.selectorDimensions.height>>1);h=i('<div class="jq-iast-selector">').css(i.extend({backgroundImage:t,backgroundSize:a+"px "+r+"px",backgroundPositionX:(this.options.dimensions.width>>1)-(a>>1)-s,backgroundPositionY:(this.options.dimensions.height>>1)-(r>>1)-m},this.options.selectorDimensions)).appendTo(n),n.insertAfter(u),u.remove(),n.on("touchstart",i.proxy(o.onTouchStart,o))},this.onTouchStart=function(t){var s=t.originalEvent.touches;switch(s.length){case 2:this.onPinchStart(t),u.trigger("pinching start");case 1:if(this.isDragging)break;default:n.on("touchend",i.proxy(this.onTouchEnd,this)),this.onDragStart(s),u.trigger("dragging start"),console.log("dragging start",t)}u.trigger("touchStart")},this.onTouchEnd=function(i){var t=i.originalEvent.touches;switch(t.length){case 2:u.trigger("pinching end"),this.isPinching&&this.onPinchEnd();break;case 1:u.trigger("dragging end");break;case 0:default:this.onDragEnd(),u.trigger("touchEnd"),n.off("touchend")}},this.onDragStart=function(t){this.isDragging=!0,this.px[0]=t[0].pageX,this.py[0]=t[0].pageY,n.on("touchmove",i.proxy(this.onDragMove,this))},this.onDragEnd=function(i){this.isDragging=!1,i||n.off("touchmove")},this.onDragMove=function(i){if(this.isPinching){i.preventDefault();var t=i.originalEvent.touches;this.dx[0]=t[0].pageX-this.px[0],this.dy[0]=t[0].pageY-this.py[0],this.px[0]=t[0].pageX,this.py[0]=t[0].pageY,this.bgOffsetX+=this.dx[0],this.bgOffsetY+=this.dy[0];var s=this.boundedOffset(this.bgOffsetX,this.bgOffsetY);this.bgOffsetX=s.x,this.bgOffsetY=s.y,e.css({backgroundPositionX:s.x+(this.options.dimensions.width>>1)-(a>>1),backgroundPositionY:s.y+(this.options.dimensions.height>>1)-(r>>1)});var o=(this.options.dimensions.width>>1)-(this.options.selectorDimensions.width>>1),n=(this.options.dimensions.height>>1)-(this.options.selectorDimensions.height>>1);h.css({backgroundPositionX:s.x+(this.options.dimensions.width>>1)-(a>>1)-o,backgroundPositionY:s.y+(this.options.dimensions.height>>1)-(r>>1)-n})}},this.boundedOffset=function(i,t){var s=-(a>>1)+(this.options.selectorDimensions.width>>1),o=(a>>1)-(this.options.selectorDimensions.width>>1),n=-(r>>1)+(this.options.selectorDimensions.height>>1),e=(r>>1)-(this.options.selectorDimensions.height>>1);return{x:Math.max(s,Math.min(o,i)),y:Math.max(n,Math.min(e,t))}},this.onPinchStart=function(i){this.isPinching=!0;var t=i.originalEvent.touches,s=t[1].pageX-t[0].pageX,o=t[1].pageY-t[0].pageY;this.pdDist=Math.sqrt(s*s+(o+o)),n.on("touchmove",this.onPinchMove)},this.onPinchEnd=function(){this.isPinching=!1,this.pdDist=0,this.px[0]=touches[0].pageX,this.py[0]=touches[0].pageY,n.off("touchmove",this.onPinchMove)},this.onPinchMove=function(i){i.preventDefault();var t=i.originalEvent.touches,s=t[1].pageX-t[0].pageX,o=t[1].pageY-t[0].pageY,n=Math.sqrt(s*s+(o+o)),g=3*(n-this.pdDist);if(g){this.pdDist=n,console.log("onPinchMove",g),1>=p?(a+=g,r=a/p):(r+=g,a=r*p);var c=this.boundedSize(a,r);a=c.width,r=c.height,e.css({backgroundSize:a+"px "+r+"px"}),h.css({backgroundSize:a+"px "+r+"px"})}},this.onPinchMove=i.proxy(this.onPinchMove,this),this.boundedSize=function(i,t){var s,o;return 1>=p?(s=this.options.selectorDimensions.width,o=s/p):(o=this.options.selectorDimensions.height,s=o*p),{width:Math.max(s,i),height:Math.max(o,t)}},this.init(),this},i.imageAreaSelectTouch.options={dimensions:{width:300,height:380,position:"relative"},bgDimensions:{width:"100%",height:"100%",position:"absolute",opacity:.5,backgroundRepeat:"no-repeat"},selectorDimensions:{width:240,height:240,position:"absolute",margin:"auto",top:0,left:0,bottom:0,right:0,border:"1px dashed white",backgroundRepeat:"no-repeat"},imgDimensions:{width:200,height:200,scale:1}},i.fn.imageAreaSelectTouch=function(t){return this.each(function(){i(this);var s,o;return t=t||{},(o=this.imageAreaSelectTouch)||(this.imageAreaSelectTouch=o=new i.imageAreaSelectTouch(this,s)),o})},i.expr[":"].imageAreaSelectTouch=function(t){return i(t).hasClass("jq-iast-wrapper")}})(jQuery);